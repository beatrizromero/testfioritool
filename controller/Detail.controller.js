sap.ui.define(["Coty/RawMaterial/Router","Coty/RawMaterial/util/Constants","Coty/RawMaterial/util/Services","Coty/RawMaterial/util/Commons","Coty/RawMaterial/util/DataManager","sap/ui/export/Spreadsheet"],function(e,t,s,i,o,r){"use strict";return e.extend("Coty.RawMaterial.controller.Detail",{onInit:function(){this.getRouter().getRoute(t.DETAIL_VIEW).attachMatched(this.onMatchedRoute,this);sap.ui.getCore().getEventBus().subscribe(t.DETAIL_VIEW,"crossNavigation",this.onCrossNav,this);sap.ui.getCore().getEventBus().subscribe(t.DETAIL_VIEW,"localNavigation",this.onLocalNav,this)},onMatchedRoute:function(){this.checkSelectedVendor()},checkSelectedVendor:function(){let e=this.getView().getModel(t.DATAMODEL).getProperty("/Composition");if(!e){return}this.filterComposition()},onLocalNav:function(e,s,i){let o=[this.getView().getModel(t.DATAMODEL).getProperty("/MaterialSelected/RAWMATERIAL_NUMBER"),this.getView().getModel(t.DATAMODEL).getProperty("/MaterialSelected/VERSION")];this.getMaterialDetails(o)},onCrossNav:function(e,t,s){let i=[s.sRaw,s.sVersion];this.getRawDetails(i)},getRawDetails:function(e){sap.ui.core.BusyIndicator.show(0);s.getRawMaterial(e).then(s=>{sap.ui.core.BusyIndicator.hide();if(!s.results.length){return}this.getView().getModel(t.DATAMODEL).setProperty("/MaterialSelected",s.results[0]);this.getMaterialDetails(e)}).catch(e=>{sap.ui.core.BusyIndicator.hide();this.showErrorMessage(e)})},getMaterialDetails:function(e){let s=this.getPromises(e);sap.ui.core.BusyIndicator.show();Promise.all(s).then(e=>{sap.ui.core.BusyIndicator.hide();this.setDetailMaterial(e);this.getView().getModel(t.DATAMODEL).setProperty("/selectedCompositionVendor",t.DEFAULT_FILTER_VENDOR);this.filterComposition()}).catch(e=>{sap.ui.core.BusyIndicator.hide();this.showErrorMessage(e)})},getPromises:function(e){let t=[];t.push(new Promise((t,s)=>{this.callServiceFunctionalities(e,t,s)}));t.push(new Promise((t,s)=>{this.callServiceManufacturing(e,t,s)}));t.push(new Promise((t,s)=>{this.callServiceSites(e,t,s)}));t.push(new Promise((t,s)=>{this.callServiceSupliers(e,t,s)}));t.push(new Promise((t,s)=>{this.callServiceSynonyms(e,t,s)}));t.push(new Promise((t,s)=>{this.callServiceSource(e,t,s)}));t.push(new Promise((t,s)=>{this.callServiceApplication(e,t,s)}));t.push(new Promise((t,s)=>{this.callServiceHazards(e,t,s)}));t.push(new Promise((t,s)=>{this.callServiceDocument(e,t,s)}));t.push(new Promise((t,s)=>{this.callServiceTestMehods(e,t,s)}));t.push(new Promise((t,s)=>{this.callServiceComposition(e,t,s)}));t.push(new Promise((t,s)=>{this.callServiceCompliance(e,t,s)}));return t},callServiceFunctionalities:function(e,t,i){sap.ui.core.BusyIndicator.show(0);let o=e=>{t(e)};let r=e=>{i(e)};s.getFunctionalities(e,o,r)},callServiceManufacturing:function(e,t,i){sap.ui.core.BusyIndicator.show(0);let o=e=>{t(e)};let r=e=>{i(e)};s.getManufacturing(e,o,r)},callServiceSites:function(e,t,i){sap.ui.core.BusyIndicator.show(0);let o=e=>{t(e)};let r=e=>{i(e)};s.getSites(e,o,r)},callServiceSupliers:function(e,t,i){sap.ui.core.BusyIndicator.show(0);let o=e=>{t(e)};let r=e=>{i(e)};s.getSupliers(e,o,r)},callServiceSynonyms:function(e,t,i){sap.ui.core.BusyIndicator.show(0);let o=e=>{t(e)};let r=e=>{i(e)};s.getSynonyms(e,o,r)},callServiceSource:function(e,t,i){sap.ui.core.BusyIndicator.show(0);let o=e=>{t(e)};let r=e=>{i(e)};s.getSource(e,o,r)},callServiceApplication:function(e,t,i){sap.ui.core.BusyIndicator.show(0);let o=e=>{t(e)};let r=e=>{i(e)};s.getApplication(e,o,r)},callServiceHazards:function(e,t,i){sap.ui.core.BusyIndicator.show(0);let o=e=>{t(e)};let r=e=>{i(e)};s.getHazards(e,o,r)},callServiceTestMehods:function(e,t,i){sap.ui.core.BusyIndicator.show(0);let o=e=>{t(e)};let r=e=>{i(e)};s.getTestMethods(e,o,r)},callServiceComposition:function(e,t,i){sap.ui.core.BusyIndicator.show(0);let o=e=>{t(e)};let r=e=>{i(e)};s.getComposition(e,o,r)},callServiceDocument:function(e,t,i){sap.ui.core.BusyIndicator.show(0);let o=e=>{t(e)};let r=e=>{i(e)};s.getDocument(e,o,r)},callServiceCompliance:function(e,t,i){sap.ui.core.BusyIndicator.show(0);let o=e=>{t(e)};let r=e=>{i(e)};s.getCompliance(e,o,r)},setDetailMaterial:function(e){let s=this.getView().getModel(t.DATAMODEL);s.setProperty("/Functionalities",e[0].results);s.setProperty("/Manufacturing",e[1].results);s.setProperty("/Sites",e[2].results);s.setProperty("/Supliers",e[3].results);s.setProperty("/Synonyms",e[4].results);s.setProperty("/Source",e[5].results);s.setProperty("/Application",e[6].results);s.setProperty("/Hazards",e[7].results);s.setProperty("/Documents",e[8].results);s.setProperty("/TestMethods",e[9].results);s.setProperty("/Composition",o.setComponentName(e[10].results));s.setProperty("/Compliance",e[11].results);this.getSelectVendorComposition(e[10].results)},getSelectVendorComposition:function(e){e=e.filter(e=>!!e.ASUPPLIER_ID);e=Object.values(e.reduce((e,t)=>(e[t.ASUPPLIER_ID]=t,e),{}));e.unshift({ASUPPLIER_ID:t.DEFAULT_FILTER_VENDOR});this.getView().getModel(t.DATAMODEL).setProperty("/VendorsSelect",e)},onBtnPressNavBack:function(){this.navBack()},onBtnPressWhereUsed:function(){this.getRouter().navTo(t.WHEREUSED_VIEW)},onBtnPressVersions:function(){this.getRouter().navTo(t.VERSIONS_VIEW)},onPressComposition:function(e){let s=this.getView().getModel(t.DATAMODEL);let i=e.getSource().getBindingContext(t.DATAMODEL).getPath();if(s.getProperty(i+"/COMPONENT_TYPE")===t.SUBSTANCE_TYPE){this.sendDataSubstance(s.getProperty(i+"/COMPONENT_ID"));return}this.sendDataRaw(s.getProperty(i))},onPressDocuments:function(e){let s=this.getView().getModel(t.DATAMODEL);let i=e.getSource().getBindingContext(t.DATAMODEL).getPath();let o=s.getProperty(i);let r=o.DOC_TYPE_RD+o.DOC_ID_RD+o.DOC_V_SOURCE+o.DOC_PART_RD;this.callServiceGetOriginals(r)},callServiceGetOriginals:function(e){s.setModel(this.getOwnerComponent().getModel(t.DOCUMENTS_MODEL));s.getLinkDocument(e).then(e=>{sap.ui.core.BusyIndicator.hide();if(!!e.results.length){s.getDownload(e.results[0])}s.setModel(this.getOwnerComponent().getModel(t.RAWMATERIAL_MODEL))}).catch(e=>{sap.ui.core.BusyIndicator.hide();this.showErrorMessage(e);s.setModel(this.getOwnerComponent().getModel(t.RAWMATERIAL_MODEL))})},onSelectVendor:function(e){this.filterComposition()},filterComposition:function(){let e=[];let s=this.getView().getModel(t.DATAMODEL);let i=s.getProperty("/selectedCompositionVendor")===t.DEFAULT_FILTER_VENDOR?t.EMPTY:s.getProperty("/selectedCompositionVendor");e.push(new sap.ui.model.Filter(t.FILTER_VENDOR_COMPOSITION,sap.ui.model.FilterOperator.EQ,i));this.byId(t.ID_COMPOSITION_LIST).getBinding("items").filter(e)},sendDataSubstance:function(e){this.saveDataSessionStorage();let s=parseInt(this.getView().getModel(t.DATAMODEL).getProperty("/App"))+t.ONE;let o=i.replaceParameters(t.APP_SUBSTANCE,[e,t.TARGET_VIEW_DETAIL,s]);window.location.href=o},sendDataRaw:function(e){let t=[e.COMPONENT_ID,e.COMPONENT_VERSION];this.getMaterialDetails(t)},onPressDownloadComposition:function(){let e=this.getView().getModel(t.DATAMODEL);let s={workbook:{columns:this.getTemplateColumns()},dataSource:e.getProperty("/Composition"),fileName:t.EXCEL_NAME+e.getProperty("/MaterialSelected/ARAWMATERIALSPECNUMBER")+t.EXCEL_EXTENSION};let i=new r(s);i.build().finally(()=>{i.destroy()})},getTemplateColumns:function(){let e=this.byId(t.ID_COMPOSITION_LIST);let s=e.getColumns();let i=!!e.getItems().length?e.getItems()[0]:t.EMPTY;let o=[];for(let e=0;e<s.length;e++){o.push({label:s[e].getHeader().getText(),property:i?i.getCells()[e].getBinding("text").getPath():t.EMPTY,type:t.EXCEL_COLUMN_TYPE_STRING})}return o},saveDataSessionStorage:function(){let e=this.getView().getModel(t.DATAMODEL);let s=e.getProperty("/App");let i=o.getSaveRestoreData(e.getData(),t.TARGET_VIEW_DETAIL);let r=btoa(JSON.stringify(i));sessionStorage.setItem(t.SESSION_STORAGE_RAW+s,r);sessionStorage.setItem(t.RESTORE+s,true)},showErrorMessage:function(e){i.showMessage(this,sap.ui.core.ValueState.Error,sap.ui.core.ValueState.Error,i.errorSimpleMessage(this,e))},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe(t.DETAIL_VIEW,"crossNavigation",this.onCrossNav,this);sap.ui.getCore().getEventBus().unsubscribe(t.DETAIL_VIEW,"localNavigation",this.onLocalNav,this)}})});