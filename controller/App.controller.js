sap.ui.define(["Coty/RawMaterial/Router","Coty/RawMaterial/util/Services","Coty/RawMaterial/util/Constants","Coty/RawMaterial/util/DataManager"],function(e,t,r,i){"use strict";return e.extend("Coty.RawMaterial.controller.App",{onInit:function(){sap.ui.getCore().getEventBus().subscribe("appRawMaterial","init",this.handleInitRequest,this)},handleInitRequest:function(e,t,r){this.createModels();this.getDropStatus(r)},getDropStatus:function(e){t.getDropStatus().then(t=>{this.getOwnerComponent().getModel(r.DATAMODEL).setProperty("/DropStatus",t.results);this.initApp(e)}).catch(e=>{sap.ui.core.BusyIndicator.hide()})},initApp:function(e){let t=e.App?e.App:r.ZERO;let i=sessionStorage.getItem(r.RESTORE+t);if(!!i){this.restoreData(t);return}this.getRouter().initialize();this.getOwnerComponent().getModel(r.DATAMODEL).setProperty("/App",t);if(!e.sView){return}this.getRouter().navTo(e.sView,null,true);sap.ui.getCore().getEventBus().publish(e.sView,"crossNavigation",{sRaw:e.sRaw,sVersion:e.sVersion})},createModels:function(){t.setModel(this.getOwnerComponent().getModel(r.RAWMATERIAL_MODEL));this.getOwnerComponent().getModel(r.DATAMODEL).setSizeLimit(r.LIMIT_MAIN);this.getOwnerComponent().getModel(r.DATAMODEL).setProperty("/RawMaterial",[]);this.getOwnerComponent().getModel(r.DATAMODEL).setProperty("/Filters",{});this.getOwnerComponent().getModel(r.DATAMODEL).setProperty("/RowsSearched",r.ROWS_DEFAULT)},restoreData:function(e){let t=JSON.parse(atob(sessionStorage.getItem(r.SESSION_STORAGE_RAW+e)));sessionStorage.removeItem(r.SESSION_STORAGE_RAW+e);sessionStorage.removeItem(r.RESTORE+e);this.loadDataRestore(t,e);this.callServicesToRestore(t)},loadDataRestore:function(e,t){let i=this.getOwnerComponent().getModel(r.DATAMODEL);i.setProperty("/Filters",e.Filters);i.setProperty("/RowsSearched",e.RowSearched);i.setProperty("/selectedCompositionVendor",e.selectedCompositionVendor);i.setProperty("/App",t)},callServicesToRestore:function(e){let t=this.getFilters();this.callServiceGetMaterials(t,e)},getFilters:function(){let e=this.getOwnerComponent().getModel(r.DATAMODEL);let t=e.getProperty("/Filters/StatusSelected");let i=[];let s=[];if(!!e.getProperty("/Filters/FilterNumber")){s.push(new sap.ui.model.Filter("tolower("+r.FILTER_ARAWMATERIAL_ID+")",sap.ui.model.FilterOperator.Contains,"'"+e.getProperty("/Filters/FilterNumber").toLowerCase()+"'"));s.push(new sap.ui.model.Filter("tolower("+r.FILTER_MPCODE+")",sap.ui.model.FilterOperator.Contains,"'"+e.getProperty("/Filters/FilterNumber").toLowerCase()+"'"));i.push(new sap.ui.model.Filter(s,false))}if(!!e.getProperty("/Filters/FilterCode")){i.push(new sap.ui.model.Filter("tolower("+r.FILTER_CODE+")",sap.ui.model.FilterOperator.Contains,"'"+e.getProperty("/Filters/FilterCode").toLowerCase()+"'"))}if(!!e.getProperty("/Filters/FilterPreferred")){i.push(new sap.ui.model.Filter("tolower("+r.FILTER_APREFERREDNAME+")",sap.ui.model.FilterOperator.Contains,"'"+e.getProperty("/Filters/FilterPreferred").toLowerCase()+"'"))}if(!!e.getProperty("/Filters/FilterInci")){i.push(new sap.ui.model.Filter("tolower("+r.FILTER_AINCINAME+")",sap.ui.model.FilterOperator.Contains,"'"+e.getProperty("/Filters/FilterInci").toLowerCase()+"'"))}let o=[];if(!!t&&!!t.length){t.forEach(e=>{o.push(new sap.ui.model.Filter(r.FILTER_ASTATUS,sap.ui.model.FilterOperator.EQ,e))});i.push(new sap.ui.model.Filter(o,false))}if(!!e.getProperty("/Filters/FilterVendor")){i.push(new sap.ui.model.Filter("tolower("+r.FILTER_AVENDOR+")",sap.ui.model.FilterOperator.Contains,"'"+e.getProperty("/Filters/FilterVendor").toLowerCase()+"'"))}if(!!e.getProperty("/Filters/FilterTrade")){i.push(new sap.ui.model.Filter("tolower("+r.FILTER_ATRADE+")",sap.ui.model.FilterOperator.Contains,"'"+e.getProperty("/Filters/FilterTrade").toLowerCase()+"'"))}return i},callServiceGetMaterials:function(e,i){let s=this.getView().getModel(r.DATAMODEL);let o=s.getProperty("/RowsSearched");sap.ui.core.BusyIndicator.show(0);t.getRawMaterials(e,o).then(e=>{sap.ui.core.BusyIndicator.hide();this.getView().getModel(r.DATAMODEL).setProperty("/RawMaterial",e.results);this.getMaterialSelected(e.results,i.RawNumber,i.RawVersion);this.getMaterialDetails(i)}).catch(e=>{sap.ui.core.BusyIndicator.hide()})},getMaterialSelected:function(e,t,i){let s=e.find(e=>e.RAWMATERIAL_NUMBER===t&&e.VERSION===i);this.getView().getModel(r.DATAMODEL).setProperty("/MaterialSelected",s)},getMaterialDetails:function(e){let t=this.getPromises([e.RawNumber,e.RawVersion]);sap.ui.core.BusyIndicator.show();Promise.all(t).then(t=>{sap.ui.core.BusyIndicator.hide();this.setDetailMaterial(t);if(e.View===r.TARGET_VIEW_WHERE){this.getWhereUse([e.RawNumber,e.RawVersion])}if(!!t[8].results.length){return}this.getView().getModel(r.DATAMODEL).setProperty("/Documents",[])}).catch(e=>{sap.ui.core.BusyIndicator.hide()})},getPromises:function(e){let t=[];t.push(new Promise((t,r)=>{this.callServiceFunctionalities(e,t,r)}));t.push(new Promise((t,r)=>{this.callServiceManufacturing(e,t,r)}));t.push(new Promise((t,r)=>{this.callServiceSites(e,t,r)}));t.push(new Promise((t,r)=>{this.callServiceSupliers(e,t,r)}));t.push(new Promise((t,r)=>{this.callServiceSynonyms(e,t,r)}));t.push(new Promise((t,r)=>{this.callServiceSource(e,t,r)}));t.push(new Promise((t,r)=>{this.callServiceApplication(e,t,r)}));t.push(new Promise((t,r)=>{this.callServiceHazards(e,t,r)}));t.push(new Promise((t,r)=>{this.callServiceDocument(e,t,r)}));t.push(new Promise((t,r)=>{this.callServiceTestMehods(e,t,r)}));t.push(new Promise((t,r)=>{this.callServiceComposition(e,t,r)}));t.push(new Promise((t,r)=>{this.callServiceCompliance(e,t,r)}));return t},callServiceFunctionalities:function(e,r,i){sap.ui.core.BusyIndicator.show(0);let s=e=>{r(e)};let o=e=>{i(e)};t.getFunctionalities(e,s,o)},callServiceManufacturing:function(e,r,i){sap.ui.core.BusyIndicator.show(0);let s=e=>{r(e)};let o=e=>{i(e)};t.getManufacturing(e,s,o)},callServiceSites:function(e,r,i){sap.ui.core.BusyIndicator.show(0);let s=e=>{r(e)};let o=e=>{i(e)};t.getSites(e,s,o)},callServiceSupliers:function(e,r,i){sap.ui.core.BusyIndicator.show(0);let s=e=>{r(e)};let o=e=>{i(e)};t.getSupliers(e,s,o)},callServiceSynonyms:function(e,r,i){sap.ui.core.BusyIndicator.show(0);let s=e=>{r(e)};let o=e=>{i(e)};t.getSynonyms(e,s,o)},callServiceSource:function(e,r,i){sap.ui.core.BusyIndicator.show(0);let s=e=>{r(e)};let o=e=>{i(e)};t.getSource(e,s,o)},callServiceApplication:function(e,r,i){sap.ui.core.BusyIndicator.show(0);let s=e=>{r(e)};let o=e=>{i(e)};t.getApplication(e,s,o)},callServiceHazards:function(e,r,i){sap.ui.core.BusyIndicator.show(0);let s=e=>{r(e)};let o=e=>{i(e)};t.getHazards(e,s,o)},callServiceTestMehods:function(e,r,i){sap.ui.core.BusyIndicator.show(0);let s=e=>{r(e)};let o=e=>{i(e)};t.getTestMethods(e,s,o)},callServiceComposition:function(e,r,i){sap.ui.core.BusyIndicator.show(0);let s=e=>{r(e)};let o=e=>{i(e)};t.getComposition(e,s,o)},callServiceDocument:function(e,r,i){sap.ui.core.BusyIndicator.show(0);let s=e=>{r(e)};let o=e=>{i(e)};t.getDocument(e,s,o)},getWhereUse:function(e){let t=this.getPromisesWhereUsed(e);sap.ui.core.BusyIndicator.show();Promise.all(t).then(e=>{sap.ui.core.BusyIndicator.hide();let t=e[0].results.concat(e[1].results,e[2].results);this.getView().getModel(r.DATAMODEL).setProperty("/Ingredients",t)}).catch(e=>{sap.ui.core.BusyIndicator.hide()})},getPromisesWhereUsed:function(e){let t=[];t.push(new Promise((t,r)=>{this.callServiceRawComposition(e,t,r)}));t.push(new Promise((t,r)=>{this.callServiceTpmFormulas(e,t,r)}));t.push(new Promise((t,r)=>{this.callServiceStandardFormulas(e,t,r)}));return t},callServiceRawComposition:function(e,i,s){sap.ui.core.BusyIndicator.show(0);let o=e=>{e.results.map(e=>{e.Type=r.RAW_TYPE;return e});i(e)};let l=e=>{s(e)};t.getRawComposition(e,o,l)},callServiceTpmFormulas:function(e,i,s){sap.ui.core.BusyIndicator.show(0);let o=e=>{e.results.map(e=>{e.Type=r.FORMULA_TYPE;return e});i(e)};let l=e=>{s(e)};t.getTpmFormulas(e,o,l)},callServiceStandardFormulas:function(e,i,s){sap.ui.core.BusyIndicator.show(0);let o=e=>{e.results.map(e=>{e.Type=r.FORMULA_TYPE;return e});i(e)};let l=e=>{s(e)};t.getStandardFormulas(e,o,l)},callServiceCompliance:function(e,r,i){sap.ui.core.BusyIndicator.show(0);let s=e=>{r(e)};let o=e=>{i(e)};t.getCompliance(e,s,o)},setDetailMaterial:function(e){let t=this.getView().getModel(r.DATAMODEL);t.setProperty("/Functionalities",e[0].results);t.setProperty("/Manufacturing",e[1].results);t.setProperty("/Sites",e[2].results);t.setProperty("/Supliers",e[3].results);t.setProperty("/Synonyms",e[4].results);t.setProperty("/Source",e[5].results);t.setProperty("/Application",e[6].results);t.setProperty("/Hazards",e[7].results);t.setProperty("/Documents",e[8].results);t.setProperty("/TestMethods",e[9].results);t.setProperty("/Composition",i.setComponentName(e[10].results));t.setProperty("/Compliance",e[11].results);this.getSelectVendorComposition(e[10].results);this.getRouter().initialize()},getSelectVendorComposition:function(e){e=Object.values(e.reduce((e,t)=>(e[t.ASUPPLIER_ID]=t,e),{}));this.getView().getModel(r.DATAMODEL).setProperty("/VendorsSelect",e)},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe("appRawMaterial","init",this.handleInitRequest,this)}})});